!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.rtc=e()}}(function(){return function e(t,n,r){function i(s,c){if(!n[s]){if(!t[s]){var u="function"==typeof require&&require;if(!c&&u)return u(s,!0);if(o)return o(s,!0);var a=new Error("Cannot find module '"+s+"'");throw a.code="MODULE_NOT_FOUND",a}var l=n[s]={exports:{}};t[s][0].call(l.exports,function(e){var n=t[s][1][e];return i(n?n:e)},l,l.exports,e,t,n,r)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<r.length;s++)i(r[s]);return i}({1:[function(e,t,n){(function(){var e,t;e=function(e,t){return null!=t?t.bind(e):void 0},n.compat=t={PeerConnection:window.PeerConnection||window.webkitPeerConnection00||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,IceCandidate:window.RTCIceCandidate||window.mozRTCIceCandidate,SessionDescription:window.mozRTCSessionDescription||window.RTCSessionDescription,MediaStream:window.MediaStream||window.mozMediaStream||window.webkitMediaStream,getUserMedia:e(navigator,navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia),supported:function(){return null!=t.PeerConnection&&null!=t.IceCandidate&&null!=t.SessionDescription&&null!=t.getUserMedia}}}).call(this)},{}],2:[function(e,t,n){(function(){var t,r,i,o,s=function(e,t){function n(){this.constructor=e}for(var r in t)c.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},c={}.hasOwnProperty;o=e("./internal/promise"),t=o.Deferred,i=o.Promise,r=e("events").EventEmitter,n.DataChannel=function(e){function n(e,t){this.channel=e,this.max_buffer=null!=t?t:10240,this._connected=!1,this._connect_queue=[],this._send_buffer=[],this.channel.binaryType="arraybuffer",this.channel.onmessage=function(e){return function(t){return e._connected?e.emit("message",t.data):e._connect_queue.push(t.data)}}(this),this.channel.onclose=function(e){return function(){return e.emit("closed")}}(this),this.channel.onerror=function(e){return function(t){return e.emit("error",t)}}(this)}return s(n,e),n.prototype.connect=function(){var e,t,n,r;for(this._connected=!0,r=this._connect_queue,t=0,n=r.length;n>t;t++)e=r[t],this.emit("message",e);return delete this._connect_queue,i.resolve()},n.prototype.close=function(){return this.channel.close(),i.resolve()},n.prototype.label=function(){return this.channel.label},n.prototype.send=function(e){var n;return this._connected||(this.connect(),console.log("Sending without being connected. Please call connect() on the data channel to start using it.")),n=new t,this._send_buffer.push([e,n]),1===this._send_buffer.length&&this._actualSend(),n.promise},n.prototype._actualSend=function(){var e,t,n,r,i;if("open"!==this.channel.readyState){for(i=[];this._send_buffer.length;)r=this._send_buffer.shift(),e=r[0],t=r[1],i.push(t.reject(new Error("DataChannel closed")));return i}for(;this._send_buffer.length;){if(this.channel.bufferedAmount>=this.max_buffer)return void setTimeout(this._actualSend.bind(this),1);n=this._send_buffer[0],e=n[0],t=n[1];try{this.channel.send(e)}catch(o){return void setTimeout(this._actualSend.bind(this),1)}t.resolve(),this._send_buffer.shift()}},n}(r)}).call(this)},{"./internal/promise":4,events:void 0}],3:[function(e,t,n){(function(){var t,r,i,o,s=function(e,t){function n(){this.constructor=e}for(var r in t)c.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},c={}.hasOwnProperty;o=e("./promise"),t=o.Deferred,i=o.Promise,r=e("events").EventEmitter,n.ChannelCollection=function(e){function n(){this.channels={},this.defers={},this.pending={},this.wait_d=new t,this.wait_p=this.wait_d.promise}return s(n,e),n.prototype.setLocal=function(e){return this.local=e,null!=this.remote?this._update():void 0},n.prototype.setRemote=function(e){return this.remote=e,null!=this.local?this._update():void 0},n.prototype._update=function(){var e,n,r,o,s;s=this.remote;for(o in s)n=s[o],null!=this.local[o]?null!=this.channels[o]||(null!=this.pending[o]?(e=this.pending[o],delete this.pending[o],this.channels[o]=i.resolve(e),this.emit("data_channel_added",o,this.channels[o])):(r=new t,this.channels[o]=r.promise,this.defers[o]=r,this.emit("data_channel_added",o,this.channels[o]))):console.log("DataChannel offered by remote but not by local");for(o in this.local)null==this.remote[o]&&console.log("DataChannel offered by local but not by remote");return this.wait_d.resolve()},n.prototype.resolve=function(e){var t;return t=e.label(),null!=this.defers[t]?(this.defers[t].resolve(e),delete this.defers[t]):this.pending[t]=e},n.prototype.get=function(e){return this.wait_p.then(function(t){return function(){if(null!=t.channels[e])return t.channels[e];throw new Error("DataChannel not negotiated")}}(this))},n}(r)}).call(this)},{"./promise":4,events:void 0}],4:[function(e,t,n){(function(t){(function(){n.Promise=t.Promise||e("es6-promise").Promise,n.Deferred=function(){function e(){this.promise=new n.Promise(function(e){return function(t,n){return e.resolve=t,e.reject=n}}(this))}return e}(),n.timeout=function(e,t){return new Promise(function(n,r){return e.then(n,r),setTimeout(function(){return r(new Error("Operation timed out"))},t)})}}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"es6-promise":void 0}],5:[function(e,t,n){(function(){var t,r,i=function(e,t){function n(){this.constructor=e}for(var r in t)o.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},o={}.hasOwnProperty;t=e("./promise").Deferred,r=e("events").EventEmitter,n.StreamCollection=function(e){function n(){this.streams={},this._defers={},this._waiting={},this._pending={},this.wait_d=new t,this.wait_p=this.wait_d.promise}return i(n,e),n.prototype.update=function(e){var n,r,i,o,s,c,u,a,l;for(s=[],this._waiting={},u=this.streams,l=r=0,o=u.length;o>r;l=++r)c=u[l],null==e[c]&&(delete this.streams[c],this.emit("stream_removed",c),l.isFullfilled()?l.then(function(e){return e.close()}):l.isPending()&&l.reject(new Error("Stream removed before being established")));for(c in e)i=e[c],null==this.streams[c]&&(n=new t,this.streams[c]=n.promise,this._defers[c]=n,this.emit("stream_added",c,n.promise)),null!=this._defers[c]&&(null!=this._pending[i]?(a=this._pending[i],delete this._pending[i],this._defers[c].resolve(a),delete this._defers[c]):this._waiting[i]=c);return this.wait_d.resolve()},n.prototype.resolve=function(e){var t,n;return t=e.id(),"default"===t&&(1===Object.keys(this.streams).length&&1===Object.keys(this._waiting).length?(console.log("Working around incompatibility between Firefox and Chrome concerning stream identification"),t=Object.keys(this._waiting)[0]):console.log("Unable to work around incompatibility between Firefox and Chrome concerning stream identification")),null!=this._waiting[t]?(n=this._waiting[t],delete this._waiting[t],this._defers[n].resolve(e),delete this._defers[n]):this._pending[t]=e},n.prototype.get=function(e){return this.wait_p.then(function(t){return function(){if(null!=t.streams[e])return t.streams[e];throw new Error("Stream not offered")}}(this))},n}(r)}).call(this)},{"./promise":4,events:void 0}],6:[function(e,t){(function(){var n,r;r=function(e,t){var r,i;for(r in t)i=t[r],e[r]=i;return n},t.exports=n={internal:{},signaling:{}},r(n,e("./peer")),r(n,e("./remote_peer")),r(n,e("./local_peer")),r(n,e("./peer_connection")),r(n,e("./stream")),r(n,e("./compat")),r(n,e("./room")),r(n,e("./video_element")),r(n.internal,e("./internal/stream_collection")),r(n.internal,e("./internal/channel_collection")),r(n.internal,e("./internal/promise")),r(n.signaling,e("./signaling/web_socket_channel")),r(n.signaling,e("./signaling/palava_signaling")),r(n.signaling,e("./signaling/calling_signaling")),r(n.signaling,e("./signaling/muc_signaling"))}).call(this)},{"./compat":1,"./internal/channel_collection":3,"./internal/promise":4,"./internal/stream_collection":5,"./local_peer":7,"./peer":8,"./peer_connection":9,"./remote_peer":10,"./room":11,"./signaling/calling_signaling":12,"./signaling/muc_signaling":13,"./signaling/palava_signaling":14,"./signaling/web_socket_channel":16,"./stream":17,"./video_element":18}],7:[function(e,t,n){(function(){var t,r,i=function(e,t){function n(){this.constructor=e}for(var r in t)o.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},o={}.hasOwnProperty;t=e("./peer").Peer,r=e("./stream").Stream,n.LocalPeer=function(e){function t(){this.streams={},this.channels={},this._status={}}return i(t,e),t.prototype.status=function(e,t){return null==t?this._status[e]:(this._status[e]=t,void this.emit("status_changed",this._status))},t.prototype.addDataChannel=function(e,t){"string"!=typeof e&&(t=e,e=this.DEFAULT_CHANNEL),null==t&&(t={ordered:!0}),this.channels[e]=t,this.emit("configuration_changed")},t.prototype.addStream=function(e,t){var n,i;return n=function(t){return function(n){return t.streams[e]=n,t.emit("configuration_changed"),n}}(this),"string"!=typeof e&&(t=e,e=this.DEFAULT_STREAM),null!=(null!=t?t.then:void 0)?n(t):t instanceof r?n(Promise.resolve(t)):(i=r.createStream(t),n(i))},t.prototype.stream=function(e){return null==e&&(e=this.DEFAULT_STREAM),this.streams[e]},t.prototype.isLocal=function(){return!0},t}(t)}).call(this)},{"./peer":8,"./stream":17}],8:[function(e,t,n){(function(){var t,r=function(e,t){function n(){this.constructor=e}for(var r in t)i.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},i={}.hasOwnProperty;t=e("events").EventEmitter,n.Peer=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return r(t,e),t.prototype.DEFAULT_CHANNEL="data",t.prototype.DEFAULT_STREAM="stream",t.prototype.status=function(){throw new Error("Not implemented")},t}(t)}).call(this)},{events:void 0}],9:[function(e,t,n){(function(){var t,r,i,o,s,c,u,a=function(e,t){function n(){this.constructor=e}for(var r in t)l.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},l={}.hasOwnProperty;u=e("./internal/promise"),r=u.Deferred,o=u.Promise,i=e("events").EventEmitter,s=e("./stream").Stream,t=e("./data_channel").DataChannel,c=e("./compat").compat,n.PeerConnection=function(e){function n(e,n){var i;this.offering=e,this.options=n,i=[],this.no_gc_bugfix=[],null!=this.options.stun&&i.push({url:this.options.stun}),null!=this.options.turn&&i.push(this.options.turn),this.pc=new c.PeerConnection({iceServers:i}),this.connect_d=new r,this.connected=!1,this.connect_d.promise["catch"](function(){}),this.signaling_pending=[],this.pc.onicecandidate=function(e){return function(t){return e.emit("ice_candidate",t.candidate)}}(this),this.pc.onaddstream=function(e){return function(t){return e.emit("stream_added",new s(t.stream))}}(this),this.pc.ondatachannel=function(e){return function(n){return e.emit("data_channel_ready",new t(n.channel))}}(this),this.pc.onremovestream=function(){},this.pc.onnegotiationneeded=function(){return function(){return console.log("onnegotiationneeded called")}}(this),this.pc.oniceconnectionstatechange=function(e){return function(){var t;return"failed"===e.pc.iceConnectionState?e._connectError(new Error("Unable to establish ICE connection")):"closed"===e.pc.iceConnectionState?e.connect_d.reject(new Error("Connection was closed")):"connected"===(t=e.pc.iceConnectionState)||"completed"===t?e.connect_d.resolve():void 0}}(this),this.pc.onsignalingstatechange=function(){}}return a(n,e),n.prototype.signaling=function(e){var t;return t=new c.SessionDescription(e),this._setRemoteDescription(t).then(function(t){return function(){return"offer"===e.type&&t.connected?t._answer():void 0}}(this))["catch"](function(e){return function(t){return e._connectError(t)}}(this))},n.prototype.addIceCandidate=function(e){var t;return null!=(null!=e?e.candidate:void 0)?(t=new c.IceCandidate(e),this.pc.addIceCandidate(t)):console.log("ICE trickling stopped")},n.prototype._oaOptions=function(){return{optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}}},n.prototype._setRemoteDescription=function(e){return new o(function(t){return function(n,r){var i;return i=new c.SessionDescription(e),t.pc.setRemoteDescription(e,n,r)}}(this))},n.prototype._offer=function(){return new o(function(e){return function(t,n){return e.pc.createOffer(t,n,e._oaOptions())}}(this)).then(function(e){return function(t){return e._processLocalSdp(t)}}(this))["catch"](function(e){return function(t){return e._connectError(t)}}(this))},n.prototype._answer=function(){return new o(function(e){return function(t,n){return e.pc.createAnswer(t,n,e._oaOptions())}}(this)).then(function(e){return function(t){return e._processLocalSdp(t)}}(this))["catch"](function(e){return function(t){return e._connectError(t)}}(this))},n.prototype._processLocalSdp=function(e){return new o(function(t){return function(n,r){var i;return i=function(){var r;return r={sdp:e.sdp,type:e.type},t.emit("signaling",r),n(e)},t.pc.setLocalDescription(e,i,r)}}(this))},n.prototype._connectError=function(e){return this.connect_d.reject(e),console.log(e),this.emit("error",e)},n.prototype.addStream=function(e){return this.pc.addStream(e.stream)},n.prototype.removeSream=function(e){return this.pc.removeStream(e.stream)},n.prototype.addDataChannel=function(e,n){var r;return this.offering?(r=this.pc.createDataChannel(e,n),this.no_gc_bugfix.push(r),r.onopen=function(e){return function(){return e.emit("data_channel_ready",new t(r))}}(this)):void 0},n.prototype.connect=function(){return this.connected||(this.offering?this._offer():"have-remote-offer"===this.pc.signalingState&&this._answer(),this.connected=!0),o.resolve(this.connect_d.promise)},n.prototype.close=function(){return this.pc.close(),this.emit("closed")},n}(i)}).call(this)},{"./compat":1,"./data_channel":2,"./internal/promise":4,"./stream":17,events:void 0}],10:[function(e,t,n){(function(){var t,r,i,o,s,c=function(e,t){function n(){this.constructor=e}for(var r in t)u.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},u={}.hasOwnProperty;i=e("./internal/promise").Promise,r=e("./peer").Peer,o=e("./internal/stream_collection").StreamCollection,t=e("./internal/channel_collection").ChannelCollection,s=function(){var e,t,n,r,i,o;for(i={},t=0,r=arguments.length;r>t;t++){e=arguments[t];for(n in e)o=e[n],i[n]=o}return i},n.RemotePeer=function(e){function n(e,n,r,i){this.peer_connection=e,this.signaling=n,this.local=r,this.options=i,this.private_streams={},this.private_channels={},this.stream_collection=new o,this.streams=this.stream_collection.streams,this.streams_desc={},this.stream_collection.on("stream_added",function(e){return function(t,n){return e.emit("stream_added",t,n)}}(this)),this.channel_collection=new t,this.channels=this.channel_collection.channels,this.channels_desc={},this.channel_collection.on("data_channel_added",function(e){return function(t,n){return e.emit("data_channel_added",t,n)}}(this)),this.peer_connection.on("stream_added",function(e){return function(t){return e.stream_collection.resolve(t)}}(this)),this.peer_connection.on("data_channel_ready",function(e){return function(t){return e.channel_collection.resolve(t)}}(this)),this.peer_connection.on("signaling",function(e){return function(t){return t.streams=e.streams_desc,t.channels=e.channels_desc,e.signaling.send("signaling",t)}}(this)),this.signaling.on("signaling",function(e){return function(t){return e.stream_collection.update(t.streams),e.channel_collection.setRemote(t.channels),e.peer_connection.signaling(t)}}(this)),this.peer_connection.on("ice_candidate",function(e){return function(t){return e.signaling.send("ice_candidate",t)}}(this)),this.signaling.on("ice_candidate",function(e){return function(t){return e.peer_connection.addIceCandidate(t)}}(this)),this.signaling.on("status_changed",function(e){return function(t){return e.emit("status_changed",t)}}(this)),this.signaling.on("message",function(e){return function(t){return e.emit("message",t)}}(this)),this.signaling.on("left",function(e){return function(){return e.peer_connection.close(),e.emit("left")}}(this)),this.peer_connection.on("connected",function(){return function(){}}(this)),this.peer_connection.on("closed",function(){return function(){}}(this)),(null==this.options.auto_connect||this.options.auto_connect)&&this.connect()}return c(n,e),n.prototype.status=function(e){return this.signaling.status[e]},n.prototype.message=function(e){return this.signaling.send("message",e)},n.prototype.connect=function(){var e,t,n,r,o;if(null==this.connect_p){o=[],n=s(this.local.streams,this.private_streams);for(e in n)r=n[e],t=r.then(function(t){return[e,t]}),o.push(t);this.connect_p=i.all(o).then(function(t){return function(n){var i,o,c,u,a;for(i=0,o=n.length;o>i;i++)u=n[i],e=u[0],r=u[1],t.peer_connection.addStream(r),t.streams_desc[e]=r.id();a=s(t.local.channels,t.private_channels);for(e in a)c=a[e],t.peer_connection.addDataChannel(e,c),t.channels_desc[e]=c;return t.channel_collection.setLocal(t.channels_desc),t.peer_connection.connect()}}(this))}return this.connect_p},n.prototype.close=function(){this.peer_connection.close()},n.prototype.stream=function(e){return null==e&&(e=this.DEFAULT_STREAM),this.stream_collection.get(e)},n.prototype.addStream=function(e,t){var n,r;return this.options.auto_connect!==!1?i.reject("Unable to add streams directly to remote peers without 'auto_connect' option set to 'false'"):(n=function(t){return function(n){return t.private_streams[e]=n,n}}(this),"string"!=typeof e&&(t=e,e=this.DEFAULT_STREAM),null!=(null!=t?t.then:void 0)?n(t):t instanceof Stream?n(i.resolve(t)):(r=Stream.createStream(t),n(r)))},n.prototype.channel=function(e){return null==e&&(e=this.DEFAULT_CHANNEL),this.channel_collection.get(e)},n.prototype.addDataChannel=function(e,t){return this.options.auto_connect!==!1?i.reject("Unable to add channels directly to remote peers without 'auto_connect' option set to 'false'"):("string"!=typeof e&&(t=e,e=this.DEFAULT_CHANNEL),null==t&&(t={ordered:!0}),this.private_channels[e]=t,this.channel(e))},n.prototype.isLocal=function(){return!1},n}(r)}).call(this)},{"./internal/channel_collection":3,"./internal/promise":4,"./internal/stream_collection":5,"./peer":8}],11:[function(e,t,n){(function(){var t,r,i,o,s,c,u=function(e,t){function n(){this.constructor=e}for(var r in t)a.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},a={}.hasOwnProperty;t=e("events").EventEmitter,c=e("./signaling/web_socket_channel").WebSocketChannel,i=e("./signaling/muc_signaling").MucSignaling,s=e("./remote_peer").RemotePeer,r=e("./local_peer").LocalPeer,o=e("./peer_connection").PeerConnection,n.Room=function(e){function t(e,t){var n;this.signaling=e,this.options=null!=t?t:{},("string"==typeof this.signaling||this.signaling instanceof String)&&(n=new c(this.signaling),this.signaling=new i(n)),this.local=this.options.local||new r,this.signaling.setStatus(this.local._status),this.local.on("status_changed",function(e){return function(){return e.signaling.setStatus(e.local._status)}}(this)),this.signaling.on("peer_joined",function(e){return function(t){var n,r;return n=new o(t.first,e.options),r=e.createPeer(n,t),r.on("status_changed",function(t){return e.emit("peer_status_changed",r,t)}),r.on("left",function(){return delete e.peers[t.id],e.emit("peer_left",r)}),e.peers[t.id]=r,e.emit("peer_joined",r),r.on("closed",function(){return delete e.peers[t.id]})}}(this)),this.peers={}}return u(t,e),t.prototype.connect=function(){return null==this.join_p&&(this.join_p=this.signaling.connect()),this.join_p},t.prototype.leave=function(){return this.signaling.leave()},t.prototype.destroy=function(){return this.signaling.leave()},t.prototype.createPeer=function(e,t){return new s(e,t,this.local,this.options)},t}(t)}).call(this)},{"./local_peer":7,"./peer_connection":9,"./remote_peer":10,"./signaling/muc_signaling":13,"./signaling/web_socket_channel":16,events:void 0}],12:[function(e,t){(function(){var n,r,i,o,s,c,u,a,l,h,p,d,f,m,_,g,v,y,w,b=function(e,t){function n(){this.constructor=e}for(var r in t)S.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},S={}.hasOwnProperty;m=e("events").EventEmitter,w=e("../internal/promise"),_=w.Promise,f=w.Deferred,y=e("extend"),v=e("../room").Room,g=e("../remote_peer").RemotePeer,n=function(e){function t(e,t){var n;this.channel=e,this.room_options=t,this.next_tid=0,this.answers={},n=new f,this.hello_p=n.promise,this.channel.on("message",function(e){return function(t){var o,s,c;switch(e.resetPing(),t.type){case"hello":return e.id=t.id,n.resolve(t.server);case"answer":return null==t.tid?void console.log("Missing transaction id in answer"):(o=e.answers[t.tid],delete e.answers[t.tid],null==o?void console.log("Answer without expecting it"):null!=o.resolve?null!=t.error?o.reject(new Error(t.error)):o.resolve(t.data):null!=t.error?o(new Error(t.error)):o(void 0,t.data));case"invite_incoming":return null!=t.handle&&null!=t.sender&&t.room&&null!=t.status&&null!=t.peers&&null!=t.data?(s=new r(e,t.handle),c=new i(s,e.room_options,t.sender,t.data),c.signaling.init(t),e.emit("invitation",c)):void console.log("Invalid message")}}}(this)),this.channel.on("closed",function(e){return function(){return e.emit("closed"),e.ping_interval?(clearInterval(e.ping_interval),delete e.ping_interval):void 0}}(this))}return b(t,e),t.prototype.connect=function(){return this.channel.connect().then(function(e){return function(){return e.resetPing(),e.hello_p}}(this))},t.prototype.request=function(e,t){var n;return e.tid=this.next_tid++,this.channel.send(e),this.resetPing(),null==t?(n=new f,this.answers[e.tid]=n,n.promise):void(this.answers[e.tid]=t)},t.prototype.ping=function(){return this.request({type:"ping"})},t.prototype.resetPing=function(){return this.ping_timeout&&clearTimeout(this.ping_timeout),this.ping_timeout=setTimeout(function(e){return function(){return e.ping(),e.resetPing()}}(this),12e4)},t.prototype.subscribe=function(e){return new _(function(t){return function(n,r){return t.request({type:"ns_subscribe",namespace:e},function(i,s){var c,u,a,l,h,p;if(null!=i)return r(i);u=new o(t,e),a=s.users;for(c in a)p=a[c],u.addUser(c,p);l=s.rooms;for(c in l)h=l[c],u.addRoom(c,h.status,h.peers);return n(u)})}}(this))},t.prototype.register=function(e){return this.request({type:"ns_user_register",namespace:e})},t.prototype.unregister=function(e){return this.request({type:"ns_user_unregister",namespace:e})},t.prototype.room=function(e,t){var n;return n=this.room_signaling(e),new h(n,t||this.room_options)},t.prototype.room_signaling=function(e){return new p(this,function(t){return function(n,r){return t.request({type:"room_join",room:e,status:n},r)}}(this))},t.prototype.setStatus=function(e){return this.request({type:"status",status:e})},t.prototype.close=function(){return this.channel.close()},t}(m),o=function(e){function t(e,t){var n;this.calling=e,this.id=t,this.users={},this.rooms={},n=function(e){return function(t){var n,r,i;if(t.namespace===e.id)switch(t.type){case"ns_user_add":return null==t.user||null==t.status?void console.log("Invalid message"):e.addUser(t.user,t.status);case"ns_user_update":return null==t.user||null==t.status?void console.log("Invalid message"):(i=e.users[t.user],null==i?void console.log("Unknown user in status change"):(i.status=t.status,e.emit("user_changed",i),e.emit("user_status_changed",i,i.status),i.emit("status_changed",i.status)));case"ns_user_rm":return null==t.user?void console.log("Invalid message"):(i=e.users[t.user],null==i?void console.log("Unknown user leaving"):(delete e.users[t.user],e.emit("user_changed",i),e.emit("user_left",i),i.emit("left")));case"ns_room_add":return null==t.room||null==t.status||null==t.peers?void console.log("Invalid message"):e.addRoom(t.room,t.status,t.peers);case"ns_room_update":return null==t.room||null==t.status?void console.log("Invalid message"):(r=e.rooms[t.room],null==r?void console.log("Invalid room"):(r.status=t.status,e.emit("room_changed",r),e.emit("room_status_changed",r,r.status),r.emit("status_changed",r.status)));case"ns_room_rm":return null==t.room?void console.log("Invalid message"):(r=e.rooms[t.room],null==r?void console.log("Invalid room"):(delete e.rooms[t.room],e.emit("room_changed",r),e.emit("room_closed"),r.emit("closed")));case"ns_room_peer_add":return null==t.room||null==t.user||null==t.status||null==t.pending?void console.log("Invalid message"):(r=e.rooms[t.room],null==r?void console.log("Invalid room"):(n=r.addPeer(t.user,t.status,t.pending),e.emit("room_changed",r),e.emit("room_peer_joined",r,n)));case"ns_room_peer_update":if(null==t.room||null==t.user)return void console.log("Invalid message");if(r=e.rooms[t.room],n=null!=r?r.peers[t.user]:void 0,null==n)return void console.log("Invalid peer");if(null!=t.status&&(n.status=t.status,e.emit("room_changed",r),e.emit("room_peer_status_changed",r,n,n.status),n.emit("status_changed",n.status)),null!=t.pending&&t.pending===!1)return n.pending=!1,n.accepted_d.resolve(),e.emit("room_changed",r),e.emit("peer_accepted",n),n.emit("accepted");break;case"ns_room_peer_rm":return null==t.room||null==t.user?void console.log("Invalid message"):(r=e.rooms[t.room],n=null!=r?r.peers[t.user]:void 0,null==n?void console.log("Invalid peer"):(delete e.rooms[t.room].peers[t.user],e.emit("room_changed",r),e.emit("room_peer_left",r,n),n.emit("left")))}}}(this),this.calling.channel.on("message",n),this.on("unsubscribed",function(e){return function(){return e.calling.channel.removeListener("message",n)}}(this))}return b(t,e),t.prototype.addUser=function(e,t){var n;return n=new u(e,t),this.users[e]=n,this.emit("user_changed",n),this.emit("user_registered",n),n},t.prototype.addRoom=function(e,t,n){var r,i,o;o=new s(e,t);for(i in n)r=n[i],o.addPeer(i,r.status,r.pending);return this.rooms[e]=o,this.emit("room_changed",o),this.emit("room_registered",o),o},t.prototype.unsubscribe=function(){return new _(function(e){return function(t,n){return e.calling.request({type:"ns_unsubscribe",namespace:e.id},function(r){var i,o,s;if(null!=r)return n(r);o=e.users;for(i in o)s=o[i],s.emit("left");return e.users={},e.emit("unsubscribed"),t()})}}(this))},t}(m),u=function(e){function t(e,t,n){this.id=e,this.status=t,this.pending=n}return b(t,e),t}(m),s=function(e){function t(e,t){this.id=e,this.status=t,this.peers={}}return b(t,e),t.prototype.addPeer=function(e,t,n){var r;return r=new c(e,t,n),this.peers[e]=r,this.emit("peer_joined",r),r},t}(m),c=function(e){function t(e,t,n){this.id=e,this.status=t,this.pending=n,this.accepted_d=new f,this.pending||this.accepted_d.resolve(),this.on("left",function(e){return function(){return e.accepted_d.reject("Peer left")}}(this))}return b(t,e),t.prototype.accepted=function(){return this.accepted_d.promise},t}(m),p=function(e){function t(e,t){var n;this.calling=e,this.connect_fun=t,this.peer_status={},this.peers={},this.initialized=!1,n=function(e){return function(t){var n;if(t.room===e.id)switch(t.type){case"room_update":return null==t.status?void console.log("Invalid message"):(e.status=t.status,e.emit("status_changed",e.status));case"room_peer_add":return null==t.user||null==t.pending||null==t.status?void console.log("Invalid message"):e.addPeer(t.user,t.status,t.pending,!0);case"room_peer_rm":return console.log("removing"),null==t.user?void console.log("Invalid message"):(n=e.peers[t.user],null==n?void console.log("Unknown peer accepted"):(delete e.peers[t.user],n.accepted_d.reject("User left"),console.log("removed",e.peers),e.emit("peer_left",n),n.emit("left")));case"room_peer_update":if(null==t.user)return void console.log("Invalid message");if(n=e.peers[t.user],null==n)return void console.log("Unknown peer accepted");if(null!=t.status&&(n.status=t.status,e.emit("peer_status_changed",n,n.status),n.emit("status_changed",n.status)),null!=t.pending&&t.pending===!1)return n.pending=!1,n.accepted_d.resolve(),e.emit("peer_accepted"),n.emit("accepted");break;case"room_peer_from":return null==t.user||null==t.event?void console.log("Invalid message",t):(n=e.peers[t.user],null==n?void console.log("Unknown peer accepted"):(e.emit("peer_left"),n.emit(t.event,t.data)))}}}(this),this.calling.channel.on("message",n),this.on("left",function(e){return function(){return e.calling.channel.removeListener("message",n)}}(this))}return b(t,e),t.prototype.init=function(e){var t,n,r;if(this.initialized)throw new Error("Room is already initialized");if(null==e.room||null==e.peers||null==e.status)throw console.log(e),new Error("Invalid initialization data");this.id=e.room,this.status=e.status,n=e.peers;for(r in n)t=n[r],this.addPeer(r,t.status,t.pending,!1);return this.initialized=!0},t.prototype.connect=function(){return null==this.connect_p&&(this.connect_p=new _(function(e){return function(t,n){return e.connect_fun(e.peer_status,function(r,i){return null!=r?n(r):(null!=i&&e.init(i),e.initialized?t():void n(new Error("Missing information from connect response")))})}}(this))),this.connect_p},t.prototype.addPeer=function(e,t,n,r){var i;return i=new d(this,e,t,n,r),this.peers[e]=i,this.emit("peer_joined",i),i},t.prototype.leave=function(){return new _(function(e){return function(t){return e.calling.request({type:"room_leave",room:e.id},function(){var n,r,i;e.emit("left"),i=e.peers;for(n in i)r=i[n],r.emit("left"),r.accepted_d.reject("You left the room");return t()})}}(this))},t.prototype.setStatus=function(e){return this.peer_status=e,null!=this.connect_p?this.calling.request({type:"room_peer_status",room:this.id,status:e}):_.resolve()},t.prototype.invite=function(e,t){return null==t&&(t={}),new _(function(n){return function(r,i){return n.calling.request({type:"invite_send",room:n.id,user:e.id,data:t},function(t,o){var s;return null!=t?i(t):null==o.handle?void i(new Error("Invalid response")):(s=new a(n.calling,o.handle,e),r(s))})}}(this))},t.prototype.setRoomStatusSafe=function(e,t,n){return new _(function(r){return function(i,o){return r.calling.request({type:"room_status",room:r.id,key:e,value:t,check:!0,previous:n},function(n){return n?void o(n):(r.status[e]=t,r.emit("status_changed",r.status),i())})}}(this))},t.prototype.setRoomStatus=function(e,t){return new _(function(n){return function(r,i){return n.calling.request({type:"room_status",room:n.id,key:e,value:t},function(o){return o?void i(o):(n.status[e]=t,n.emit("status_changed",n.status),r())})}}(this))},t.prototype.register=function(e){return this.calling.request({type:"ns_room_register",namespace:e,room:this.id})},t.prototype.unregister=function(e){return this.calling.request({type:"ns_room_unregister",namespace:e,room:this.id})},t}(m),d=function(e){function t(e,t,n,r,i){this.room=e,this.id=t,this.status=n,this.pending=r,this.first=i,this.accepted_d=new f,this.pending||this.accepted_d.resolve()}return b(t,e),t.prototype.accepted=function(){return this.accepted_d.promise},t.prototype.send=function(e,t){return this.room.calling.request({type:"room_peer_to",room:this.room.id,user:this.id,event:e,data:t})},t}(m),r=function(e){function t(e,t,n,r){var i;this.calling=e,this.handle=t,this.sender=n,this.data=r,this.cancelled=!1,i=function(e){return function(t){if(t.handle===e.handle)switch(t.type){case"invite_cancelled":return e.cancelled=!0,e.emit("cancelled"),e.emit("handled",!1)}}}(this),this.calling.channel.on("message",i),this.on("handled",function(e){return function(){return e.calling.channel.removeListener("message",i)}}(this))}return b(t,e),t.prototype.signaling=function(){return new p(this.calling,function(e){return function(t,n){return e.emit("handled",!0),e.calling.request({type:"invite_accept",handle:e.handle,status:t},n)};

}(this))},t.prototype.deny=function(){return this.emit("handled",!1),this.calling.request({type:"invite_deny",handle:this.handle})},t}(m),a=function(){function e(e,t,n){var r,i;this.calling=e,this.handle=t,this.user=n,this.defer=new f,this.pending=!0,i=function(e){return function(t){if(t.handle===e.handle)switch(t.type){case"invite_response":return null==t.accepted?void console.log("Invalid message"):(e.pending=!1,e.defer.resolve(t.accepted))}}}(this),this.calling.channel.on("message",i),r=function(e){return function(){return e.calling.channel.removeListener("message",i)}}(this),this.defer.promise.then(r,r)}return e.prototype.response=function(){return this.defer.promise},e.prototype.cancel=function(){return this.pending=!1,this.calling.request({type:"invite_cancel",handle:this.handle}).then(function(e){return function(){e.defer.reject(new Error("Invitation cancelled"))}}(this))},e}(),h=function(e){function t(e,n){n=y({auto_connect:!1},n),t.__super__.constructor.call(this,e,n)}return b(t,e),t.prototype.createPeer=function(e,t){return new l(e,t,this.local,this.options)},t.prototype.invite=function(e){return this.signaling.invite(e)},t.prototype.register=function(e){return this.signaling.register(e)},t.prototype.unregister=function(e){return this.signaling.unregister(e)},t}(v),i=function(e){function t(e,n,r,i){this.invitation=e,this.sender_id=r,this.data=i,t.__super__.constructor.call(this,this.invitation.signaling(),n),this.invitation.on("cancelled",function(e){return function(){return e.emit("cancelled")}}(this)),this.invitation.on("handled",function(e){return function(t){return e.emit("handled",t)}}(this))}return b(t,e),t.prototype.sender=function(){return this.peers[this.sender_id]},t.prototype.deny=function(){return this.invitation.deny()},t}(h),l=function(e){function t(e,n,r,i){t.__super__.constructor.call(this,e,n,r,i)}return b(t,e),t.prototype.connect=function(){return this.signaling.accepted().then(function(e){return function(){return t.__super__.connect.call(e)}}(this))},t}(g),t.exports={Calling:n,CallingNamespace:o,CallingNamespaceUser:u,CallingNamespaceRoom:s,CallingNamespaceRoomPeer:c,CallingSignaling:p,CallingSignalingPeer:d,CallingInInvitation:r,CallingOutInvitation:a}}).call(this)},{"../internal/promise":4,"../remote_peer":10,"../room":11,events:void 0,extend:void 0}],13:[function(e,t,n){(function(){var t,r,i,o,s,c=function(e,t){function n(){this.constructor=e}for(var r in t)u.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},u={}.hasOwnProperty;t=e("../internal/promise").Deferred,s=e("./signaling"),i=s.Signaling,o=s.SignalingPeer,r=e("events").EventEmitter,n.MucSignalingPeer=function(e){function t(e,t,n,r){var i;this.channel=e,this.id=t,this.status=n,this.first=r,i=function(e){return function(t){if(t.peer===e.id&&null!=t.type)switch(t.type){case"from":if(null==t.event||null==t.data)return;return e.emit(t.event,t.data);case"peer_left":return e.emit("left"),e.channel.removeListener("message",i);case"peer_status":return e.status=t.status,e.emit("status_changed",e.status)}}}(this),this.channel.on("message",i)}return c(t,e),t.prototype.send=function(e,t){return null==t&&(t={}),this.channel.send({type:"to",peer:this.id,event:e,data:t})},t}(o),n.MucSignaling=function(e){function r(e){var r;this.channel=e,this.status={},r=new t,this.join_p=r.promise,this.channel.on("closed",function(e){return function(){return e.emit("closed")}}(this)),this.channel.on("message",function(e){return function(t){var i,o,s,c;if(null!=t.type)switch(t.type){case"joined":if(null==t.peers)return;s=t.peers;for(o in s)c=s[o],i=new n.MucSignalingPeer(e.channel,o,c,!1),e.emit("peer_joined",i);return e.id=t.id,r.resolve();case"peer_joined":if(null==t.peer)return;return i=new n.MucSignalingPeer(e.channel,t.peer,t.status,!0),e.emit("peer_joined",i)}}}(this))}return c(r,e),r.prototype.connect=function(){return null==this.connect_p&&(this.connect_p=this.channel.connect().then(function(e){return function(){return e.channel.send({type:"join",status:e.status})}}(this)).then(function(e){return function(){return e.join_d}}(this))),this.connect_p},r.prototype.setStatus=function(e){return this.status=e,this.connect_p?this.connect_p.then(function(t){return function(){return t.channel.send({type:"status",status:e})}}(this)):void 0},r.prototype.leave=function(){return this.channel.send({type:"leave"}).then(function(){return this.channel.close()})},r}(i)}).call(this)},{"../internal/promise":4,"./signaling":15,events:void 0}],14:[function(e,t,n){(function(){var t,r,i,o,s=function(e,t){function n(){this.constructor=e}for(var r in t)c.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},c={}.hasOwnProperty;t=e("../internal/promise").Deferred,o=e("./signaling"),r=o.Signaling,i=o.SignalingPeer,n.PalavaSignalingPeer=function(e){function t(e,t,n,r){var i;this.channel=e,this.id=t,this.status=n,this.first=r,i=function(e){return function(t){return t.sender_id===e.id?null==t.event?void e.send("error","Invalid message"):e.emit(t.event,t.data):void 0}}(this),this.channel.on("message",i),this.on("peer_updated_status",function(e){return function(t){return e.emit("status_changed",t)}}(this)),this.on("peer_left",function(e){return function(){return e.emit("closed"),e.channel.removeListener("message",i)}}(this))}return s(t,e),t.prototype.send=function(e,t){return null==t&&(t={}),this.channel.send({event:"send_to_peer",peer_id:this.id,data:{event:e,data:t}})},t}(i),n.PalavaSignaling=function(e){function r(e,r,i){var o;this.channel=e,this.room=r,this.status=i,this.peers={},this.joined=!1,o=new t,this.join_p=o.promise,this.channel.on("closed",function(e){return function(){return e.emit("closed")}}(this)),this.channel.on("message",function(e){return function(t){var r,i,s;if(null!=t.event)switch(t.event){case"joined_room":if(null==t.peers||null==t.own_id)return;s=t.peers;for(r in s)t=s[r],i=new n.PalavaSignalingPeer(e.channel,t.peer_id,t.status,!1),e.peers[t.peer_id]=i,e.emit("peer_joined",i);return o.resolve();case"new_peer":if(null==t.peer_id)return;return i=new n.PalavaSignalingPeer(e.channel,t.peer_id,t.status,!0),e.peers[t.peer]=i,e.emit("peer_joined",i)}}}(this))}return s(r,e),r.prototype.connect=function(){return null==this.connect_p&&(this.connect_p=this.channel.connect().then(function(e){return function(){return e.channel.send({event:"join_room",room_id:room,status:status})}}(this))),this.connect_p},r.prototype.set_status=function(e){return this.channel.send({event:"update_status",status:e})},r.prototype.leave=function(){return this.channel.close()},r}(r)}).call(this)},{"../internal/promise":4,"./signaling":15}],15:[function(e,t,n){(function(){var t,r=function(e,t){function n(){this.constructor=e}for(var r in t)i.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},i={}.hasOwnProperty;t=e("events").EventEmitter,n.Signaling=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return r(t,e),t.prototype.connect=function(){throw new Error("Not implemented")},t.prototype.close=function(){throw new Error("Not implemented")},t.prototype.setStatus=function(){throw new Error("Not implemented")},t}(t),n.SignalingPeer=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return r(t,e),t.prototype.send=function(e,t){throw null==t&&(t={}),new Error("Not implemented")},t}(t),n.Channel=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return r(t,e),t.prototype.connect=function(){throw new Error("Not implemented")},t.prototype.send=function(){throw new Error("Not implemented")},t.prototype.close=function(){throw new Error("Not implemented")},t}(t)}).call(this)},{events:void 0}],16:[function(e,t,n){(function(){var t,r,i=function(e,t){function n(){this.constructor=e}for(var r in t)o.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},o={}.hasOwnProperty,s=[].slice;r=e("../internal/promise").Promise,t=e("./signaling").Channel,n.WebSocketChannel=function(e){function t(){var e,t,n,r,i;if(e=arguments[0],i=2<=arguments.length?s.call(arguments,1):[],this.address=e,i.length>0){for(;this.address.endsWith("/");)this.address=this.address.substr(0,this.address.length-1);for(t=0,n=i.length;n>t;t++)r=i[t],this.address+="/"+encodeUriComponent(r)}}return i(t,e),t.prototype.connect=function(){return null==this.connect_p&&(this.connect_p=new r(function(e){return function(t,n){var r;return r=new WebSocket(e.address),r.onopen=function(){return e.socket=r,t()},r.onerror=function(t){return delete e.socket,e.emit("error",t),n(new Error("Unable to connect to socket"))},r.onmessage=function(t){var n;try{n=JSON.parse(t.data)}catch(r){return void e.emit("error","Unable to parse incoming message")}return e.emit("message",n)},r.onclose=function(){return e.emit("closed")}}}(this))),this.connect_p},t.prototype.send=function(e){var t;if(null==this.socket)return r.reject(new Error("Trying to send on WebSocket without being connected"));try{return this.socket.send(JSON.stringify(e)),r.resolve()}catch(n){return t=n,r.reject(t)}},t.prototype.close=function(){var e;if(null==this.socket)return r.reject(new Error("Trying to close WebSocket without being connected"));try{return this.socket.close(),r.resolve()}catch(t){return e=t,r.reject(e)}},t}(t)}).call(this)},{"../internal/promise":4,"./signaling":15}],17:[function(e,t,n){(function(){var t,r,i=function(e,t){function n(){this.constructor=e}for(var r in t)o.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},o={}.hasOwnProperty;r=e("./compat").compat,t=e("events").EventEmitter,n.Stream=function(e){function t(e){this.stream=e}return i(t,e),t.prototype.id=function(){return this.stream.id},t.prototype.hasTracks=function(e){return this.getTracks(e).length},t.prototype.getTracks=function(e){var t,n;if(e=e.toLowerCase(),"audio"===e)return this.stream.getAudioTracks();if("video"===e)return this.stream.getVideoTracks();if("both"===e)return n=this.stream.getVideoTracks(),t=this.stream.getAudioTracks(),n.concat(audio);throw new Error("Invalid stream part '"+e+"'")},t.prototype.muted=function(e){var t,n;return null==e&&(e="audio"),n=this.getTracks(e),n.length<1?!0:!(null!=(t=n[0])?t.enabled:void 0)},t.prototype.mute=function(e,t){var n,r,i,o;for(null==e&&(e=!0),null==t&&(t="audio"),i=this.getTracks(t),n=0,r=i.length;r>n;n++)o=i[n],o.enabled=!e;return this.emit("mute_changed",t,e),e},t.prototype.toggleMute=function(e){var t,n,r,i,o,s;if(null==e&&(e="audio"),s=this.getTracks(e),s.length<1)return!0;for(r=!(null!=(i=s[0])?i.enabled:void 0),t=0,n=s.length;n>t;t++)o=s[t],o.enabled=!r;return this.emit("mute_changed",e,r),r},t.prototype.stop=function(){var e,t,n,r,i;if(null!=this.stream.getTracks){for(n=this.stream.getTracks(),r=[],e=0,t=n.length;t>e;e++)i=n[e],r.push(i.stop());return r}return this.stream.stop()},t.prototype.clone=function(){if(null==this.stream.clone)throw new Error("Your browser does not support stream cloning. Firefox is expected to implement it in version 47.");return new t(this.stream.clone())},t.canClone=function(){return null!=r.MediaStream.prototype.clone},t.createStream=function(e){return null==e&&(e={audio:!0,video:!0}),new Promise(function(n,i){var o;return o=function(e){return n(new t(e))},r.getUserMedia(e,o,i)})},t}(t)}).call(this)},{"./compat":1,events:void 0}],18:[function(e,t,n){(function(){var t,r;r=e("./stream").Stream,t=e("./peer").Peer,n.MediaDomElement=function(){function e(e,t){this.dom=e,null!=this.dom.jquery&&(this.dom=this.dom[0]),this.attach(t)}return e.prototype.attach=function(e){return null==e?(delete this.stream,this.dom.pause(),this.dom.src=null):e instanceof r?(this.stream=e,"undefined"!=typeof mozGetUserMedia&&null!==mozGetUserMedia?this.dom.mozSrcObject=e.stream:this.dom.src=URL.createObjectURL(e.stream),this.dom.play()):e instanceof t?(e.isLocal()&&this.mute(),this.attach(e.stream())):null!=(null!=e?e.then:void 0)?e.then(function(e){return function(t){return e.attach(t)}}(this))["catch"](function(e){return function(t){return e.error(t)}}(this)):this.error("Tried to attach invalid data")},e.prototype.error=function(e){return console.log(e)},e.prototype.clear=function(){return this.attach()},e.prototype.mute=function(e){return null==e&&(e=!0),this.dom.muted=e},e.prototype.toggleMute=function(){return this.dom.muted=!this.dom.muted},e}()}).call(this)},{"./peer":8,"./stream":17}]},{},[6])(6)});